<div class="max-w-5xl mx-auto space-y-6">
    <div class="flex items-center justify-between mt-4">
      <div class="flex gap-2">
        @if (user && user.statut !== 'ACTIF') {
          <button class="btn-primary h-10" (click)="activate()">Activer</button>
        }
        @if (user && user.statut !== 'BLOQUE') {
          <button class="btn-rose-card h-10" (click)="block()">Bloquer</button>
        }
      </div>
      <a class="btn-ghost h-10" routerLink="/admin/users">← Tableau Utilisateurs</a>
    </div>

    @if (user) {
      <div class="card p-6 space-y-4">
        <div class="grid sm:grid-cols-2 gap-4">
          <p><b>ID:</b> {{ user.id }}</p>
          <p><b>Email:</b> {{ user.email }}</p>
          <p><b>Rôles:</b> {{ user.roles.join(', ') }}</p>
          <p><b>Statut:</b>{{" "}}<span [ngClass]="statusBadge(user.statut)">{{ user.statut }}</span></p>
        </div>

        <hr class="border-black/10">

        <form class="grid sm:grid-cols-2 gap-4" (ngSubmit)="save()">
          <div>
            <label class="text-xs">Prénom</label>
            <input class="input h-10 w-full" [(ngModel)]="form.prenom" name="prenom" required>
          </div>
          <div>
            <label class="text-xs">Nom</label>
            <input class="input h-10 w-full" [(ngModel)]="form.nom" name="nom" required>
          </div>
          <div class="sm:col-span-2">
            <label class="text-xs">Téléphone</label>
            <input class="input h-10 w-full" [(ngModel)]="form.telephone" name="telephone" placeholder="+336...">
          </div>

          <div class="sm:col-span-2 flex items-center gap-2">
            <button class="btn-primary h-10 px-6" type="submit" [disabled]="saving">
              @if (!saving) { Enregistrer } @else { <span class="opacity-80">Enregistrement…</span> }
            </button>

            <button type="button" class="btn-rose-card h-10" (click)="deleteUser()" [disabled]="deleting">
              @if (!deleting) { Supprimer l’utilisateur } @else { Suppression… }
            </button>

            @if (saveOk) { <span class="text-sm text-emerald-600">Modifications enregistrées.</span> }
            @if (saveError) { <span class="text-sm text-red-600">{{ saveError }}</span> }
          </div>
        </form>
      </div>


      <div class="card p-6 space-y-6">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Rendez-vous</h3>
          <div class="text-sm text-muted">
            @if (loadingRdv) { Chargement… } @else { {{ rdvs.length }} RDV }
          </div>
        </div>


        <form [formGroup]="filters" (ngSubmit)="apply()" class="flex flex-wrap items-end gap-3">
          <div>
            <label class="text-xs">Date</label>
            <input type="date" class="input" formControlName="date">
          </div>
          <div>
            <label class="text-xs">Statut</label>
            <select class="input" formControlName="statut">
              <option [ngValue]="''">Tous</option>
              <option [ngValue]="'EN_ATTENTE'">En attente</option>
              <option [ngValue]="'CONFIRME'">Confirmé</option>
              <option [ngValue]="'ANNULE'">Annulé</option>
              <option [ngValue]="'REFUSE'">Refusé</option>
            </select>
          </div>
          <button class="btn-ghost h-10" type="submit" [disabled]="loadingRdv">Filtrer</button>
          <button class="btn-ghost h-10" type="button" (click)="clear()" [disabled]="loadingRdv">Réinitialiser</button>
        </form>


        <div class="p-6 rounded-2xl border border-black/10">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold">À venir</h4>
            <span class="text-xs text-muted">{{ futurs.length }} élément(s)</span>
          </div>

          <div class="space-y-3 mt-3">
            @for (r of futurs; track r.id) {
              <div class="p-4 rounded-2xl border border-black/10">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="font-medium">{{ r.serviceLabel }}</div>
                    <div class="text-sm text-black/70">
                      {{ r.dateLabel }} — {{ r.heure }} → {{ r.heureFin }} · {{ r.prestataireLabel }}
                    </div>
                    <div class="mt-2 flex items-center gap-2">
                      <span class="badge" [ngClass]="r.badgeClass">{{ labelStatut(r.statut) }}</span>
                      <span class="text-[11px] px-2 py-0.5 rounded-full border"
                            [ngClass]="badgeTempsClasses(r)">
                        {{ badgeTempsLabel(r) }}
                      </span>
                    </div>
                  </div>
                  <div class="flex gap-2 shrink-0">
                    <a class="btn-ghost h-9" [routerLink]="['/prestataires', r.prestataireId]">Voir prestataire</a>
                  </div>
                </div>
              </div>
            } @empty {
              <div class="text-sm text-muted">Aucun rendez-vous à venir.</div>
            }
          </div>
        </div>


        <div class="p-6 rounded-2xl border border-black/10">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold">Passés</h4>
            <div class="flex items-center gap-3">
              <span class="text-xs text-muted">{{ passes.length }} élément(s)</span>
              <button class="btn-ghost h-9" (click)="pastOpen=!pastOpen">
                {{ pastOpen ? 'Masquer' : 'Afficher' }}
              </button>
            </div>
          </div>

          @if (pastOpen) {
            <div class="space-y-3 mt-3">
              @for (r of passes; track r.id) {
                <div class="p-4 rounded-2xl border border-black/10">
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <div class="font-medium">{{ r.serviceLabel }}</div>
                      <div class="text-sm text-black/70">
                        {{ r.dateLabel }} — {{ r.heure }} → {{ r.heureFin }} · {{ r.prestataireLabel }}
                      </div>
                      <div class="mt-2">
                        <span class="badge" [ngClass]="r.badgeClass">{{ labelStatut(r.statut) }}</span>
                      </div>
                    </div>
                    <div class="flex gap-2 shrink-0">
                      <a class="btn-ghost h-9" [routerLink]="['/prestataires', r.prestataireId]">Voir prestataire</a>
                    </div>
                  </div>
                </div>
              } @empty {
                <div class="text-sm text-muted">Aucun historique.</div>
              }
            </div>
          }
        </div>

        @if (listError) { <div class="text-sm text-red-600">{{ listError }}</div> }
      </div>
    } @else {
      <div class="text-center text-muted mt-10">Chargement…</div>
    }
  </div>